from __future__ import annotations

import argparse
from pathlib import Path

import pandas as pd


def main() -> int:
    parser = argparse.ArgumentParser(description="Plot a confusion matrix CSV generated by evaluation scripts.")
    parser.add_argument("--csv", required=True, help="Path to confusion_*.csv")
    parser.add_argument("--out", default=None, help="Output image path (PNG). Defaults to <csv>.png")
    parser.add_argument("--max_labels", type=int, default=40, help="Abort if too many labels to plot.")
    args = parser.parse_args()

    csv_path = Path(args.csv)
    if not csv_path.exists():
        raise FileNotFoundError(csv_path)

    df = pd.read_csv(csv_path, index_col=0)

    if df.shape[0] > args.max_labels:
        raise RuntimeError(f"Too many labels ({df.shape[0]}). Increase --max_labels if needed.")

    try:
        import matplotlib.pyplot as plt
    except Exception as e:
        raise RuntimeError("matplotlib is required. Install it with: pip install matplotlib") from e

    out_path = Path(args.out) if args.out else csv_path.with_suffix(".png")

    fig = plt.figure(figsize=(max(6, 0.25 * df.shape[1]), max(5, 0.25 * df.shape[0])))
    ax = fig.add_subplot(111)
    im = ax.imshow(df.values, aspect="auto")

    ax.set_xticks(range(df.shape[1]))
    ax.set_xticklabels(df.columns, rotation=90, fontsize=7)
    ax.set_yticks(range(df.shape[0]))
    ax.set_yticklabels(df.index, fontsize=7)
    ax.set_xlabel("Predicted")
    ax.set_ylabel("True")
    ax.set_title(csv_path.stem)
    fig.colorbar(im, ax=ax, fraction=0.046, pad=0.04)

    fig.tight_layout()
    out_path.parent.mkdir(parents=True, exist_ok=True)
    fig.savefig(out_path, dpi=200)
    print(f"Saved: {out_path}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
